---
title: "有状态服务的高可用治理"
date: 2018-10-30T18:10:45+08:00
lastmod: 2018-10-30T18:10:45+08:00
draft: true
tags:
- distribution
- ha
- db
categories:
- cs
---

之前从事了一段不短时间的数据库高可用方面的工作，积累了一些关于有状态服务高可用治理方面的经验。之前一直想写这篇文章，无奈细节的东西记得太多，导致很多观点不免片面，无法下笔。

# 服务的状态对高可用的影响

提到高可用，以前时常会听到一种观点，高可用只要用 keepalive 再进行切换就可以了。而现在，听到更多的观点是直接用 kubernetes 就行了，kubernetes  会提供高可用服务。很显然，这两种观点都是片面的。

## 无状态服务

无状态服务（Stateless Service）指的是对单次请求的处理，不依赖其他请求，也就是说，处理一次请求所需的全部信息，要么都包含在这个请求里，要么可以从外部获取到（比如说数据库），服务器本身不存储任何信息。

在这里，无状态服务可以理解为自身不保存状态（数据、动态配置等），仅仅通过访问数据库等外部服务来获取有状态数据的服务。拓展一下，那些在服务上保存只读缓存的服务，也可以算是无状态。在实际开发过程中，大多数 web 服务都是无状态服务。

因为服务自身不保存状态，所以服务可以随意进行重启、迁移、水平拓展、水平收缩等操作。进行以上操作前后，服务对外的表现不会存在任何变化。

对于周围数量巨大的互联网 web 程序员来说，其接触最多的东西，确实可以通过 keepalive 加上重启、切换之类的操作，亦或是托管在 kubernetes 并开启多副本来实现高可用。

## 有状态服务

相比无状态服务，有状态服务的高可用则复杂得多。有状态服务自身保存着状态、数据，想要重启、迁移之类的操作，势必要考虑这些状态、数据的迁移，这里面要考虑的事情就太多了。

首先，有状态服务也是服务，服务就得考虑服务质量，其中包括数据不会意外丢失，数据访问速度可接受。由于存储设备的限制，我们既不能把数据都放在磁盘中，也不能把数据

这就决定了很多数据必须在内存、缓存等高速、易失的存储之中。